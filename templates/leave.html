<!DOCTYPE html>
<html lang="en">


<head>

	<!-- Meta Tags -->
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Leave</title>

	<meta name="description" content="Leave">
	<meta name="keywords" content="Leave">
	<meta name="author" content="Devansh Bullion">
	<meta name="robots" content="index, follow">

	{% include 'css.html' %}

</head>

<body>

	<!-- Main Wrapper -->
	<div class="main-wrapper">

		<!-- Header -->
		{% include 'header.html' %}
		<!-- /Header -->

		<!-- Sidebar -->
		{% include 'sidebar.html' %}


		<!-- Page Wrapper -->

		<div class="page-wrapper" style="min-height: 570px;">
			<div class="content">

				<!-- Breadcrumb -->
				<div class="d-md-flex d-block align-items-center justify-content-between page-breadcrumb mb-3">
					<div class="my-auto mb-2">
						<h2 class="mb-1">Leaves</h2>
					</div>
					<div class="d-flex my-xl-auto right-content align-items-center flex-wrap ">
						<!-- <div class="me-2 mb-2">
							<div class="dropdown">
								<a href="javascript:void(0);" class="dropdown-toggle btn btn-white d-inline-flex align-items-center" data-bs-toggle="dropdown">
									<i class="ti ti-file-export me-1"></i>Export
								</a>
								<ul class="dropdown-menu  dropdown-menu-end p-3">
									<li>
										<a href="javascript:void(0);" class="dropdown-item rounded-1"><i class="ti ti-file-type-pdf me-1"></i>Export as PDF</a>
									</li>
									<li>
										<a href="javascript:void(0);" class="dropdown-item rounded-1"><i class="ti ti-file-type-xls me-1"></i>Export as Excel </a>
									</li>
								</ul>
							</div>
						</div> -->
						{% if not request.user.is_superuser %}
						<div class="mb-2">
							<a href="#" data-bs-toggle="modal" data-bs-target="#add_leaves"
								class="btn btn-primary d-flex align-items-center"><i
									class="ti ti-circle-plus me-2"></i>Add Leave</a>
						</div>
						{% endif %}

					</div>
				</div>
				<!-- /Breadcrumb -->

				<!-- Leaves Info -->

				<!-- /Leaves Info -->

				<!-- Leaves list -->
				<div class="card">

					<div class="card-body p-0">
						<div class="custom-datatable-filter table-responsive">
							<div id="DataTables_Table_0_wrapper" class="dataTables_wrapper dt-bootstrap5 no-footer">

								<div class="row dt-row">
									<div class="col-sm-12 table-responsive">
				{% if leave_applications %}
<table class="table datatable dataTable no-footer" id="DataTables_Table_0" aria-describedby="DataTables_Table_0_info">
    <thead class="thead-light">
        <tr>
            <th>Leave Type</th>
            <th>From</th>
            <th>Approved By</th>
            <th>To</th>
            <th>No of Days</th>
            <th>Status</th>
            <th></th>
        </tr>
    </thead>
    <tbody>
        {% for l in leave_applications %}
        <tr>
            <!-- Leave Type -->
            <td>
                <div class="d-flex align-items-center">
                    <p class="fs-14 fw-medium mb-0">{{ l.leave.leave_type.name }}</p>
                    {% if l.leave.reason %}
                    <a href="#" class="ms-2" data-bs-toggle="tooltip" data-bs-placement="right" data-bs-title="{{ l.leave.reason }}">
                        <i class="ti ti-info-circle text-info"></i>
                    </a>
                    {% endif %}
                </div>
            </td>

            <!-- From Date -->
            <td>
                {% if l.leave.duration_type == 'full' %}
                    {{ l.leave.from_date|date:"d M Y" }}
                {% else %}
                    {{ l.leave.half_day_date|date:"d M Y" }}
                {% endif %}
            </td>

            <!-- Approved By -->
            <td>
                <div class="d-flex align-items-center file-name-icon">
                    <div class="ms-2">
                        <h6 class="fw-medium mb-0">
                            {% if l.leave.superadmin_approval %}
                                Superadmin
                            {% elif l.leave.admin_approval %}
                                {{ l.leave.employee.manager.user.get_full_name }}
                            {% else %}
                                Pending
                            {% endif %}
                        </h6>
                        <span class="fs-12 fw-normal">
                            {% if l.leave.superadmin_approval %}
                                Superadmin
                            {% elif l.leave.admin_approval %}
                                Manager
                            {% else %}
                                Not yet approved
                            {% endif %}
                        </span>
                    </div>
                </div>
            </td>

            <!-- To Date -->
            <td>
                {% if l.leave.duration_type == 'full' %}
                    {{ l.leave.to_date|date:"d M Y" }}
                {% else %}
                    {{ l.leave.half_day_date|date:"d M Y" }}
                {% endif %}
            </td>

            <!-- Number of Days -->
            <td>
                {% if l.leave.duration_type == 'full' %}
                    {{ l.duration }} Day{% if l.duration > 1 %}s{% endif %}
                {% else %}
                    0.5 Day ({{ l.leave.half_type|title }} Half)
                {% endif %}
            </td>

            <!-- Status -->
            <td>
                <div class="dropdown">
                    <a href="javascript:void(0);" class="dropdown-toggle btn btn-sm btn-white d-inline-flex align-items-center" data-bs-toggle="dropdown">
                        <span class="rounded-circle d-flex justify-content-center align-items-center me-2 
                            {% if l.leave.superadmin_approval or l.leave.admin_approval %}
                                bg-transparent-success
                            {% elif l.leave.superadmin_cancelled or l.leave.admin_cancelled %}
                                bg-transparent-danger
                            {% else %}
                                bg-transparent-purple
                            {% endif %}">
                            <i class="ti ti-point-filled 
                                {% if l.leave.superadmin_approval or l.leave.admin_approval %}
                                    text-success
                                {% elif l.leave.superadmin_cancelled or l.leave.admin_cancelled %}
                                    text-danger
                                {% else %}
                                    text-purple
                                {% endif %}"></i>
                        </span>
                        {% if l.leave.superadmin_approval  %}
                            Approved
						
								 {% elif l.leave.superadmin_cancelled  %}
                            Declined By Super Admin

							{% elif l.leave.admin_cancelled %}
							 Declined By Admim
                   
						

						{% elif l.leave.admin_approval %}
						    Manager Approved – Pending Admin
                       
                            New
                        {% endif %}
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end p-3">
                        <li>
                            <a href="javascript:void(0);" class="dropdown-item d-flex align-items-center">
                                <span class="rounded-circle bg-transparent-success me-2 d-flex justify-content-center align-items-center">
                                    <i class="ti ti-point-filled text-success"></i>
                                </span>
                                Approved
                            </a>
                        </li>
                        <li>
                            <a href="javascript:void(0);" class="dropdown-item d-flex align-items-center">
                                <span class="rounded-circle bg-transparent-danger me-2 d-flex justify-content-center align-items-center">
                                    <i class="ti ti-point-filled text-danger"></i>
                                </span>
                                Declined
                            </a>
                        </li>
                        <li>
                            <a href="javascript:void(0);" class="dropdown-item d-flex align-items-center">
                                <span class="rounded-circle bg-transparent-purple me-2 d-flex justify-content-center align-items-center">
                                    <i class="ti ti-point-filled text-purple"></i>
                                </span>
                                New
                            </a>
                        </li>
                    </ul>
                </div>
            </td>

            <!-- Actions -->
         <td>
    <div class="action-icon d-inline-flex">
        <a href="#" class="me-2" data-bs-toggle="modal" data-bs-target="#edit_leaves">
            <i class="ti ti-edit"></i>
        </a>
        <a href="javascript:void(0);" data-bs-toggle="modal" data-bs-target="#delete_modal">
            <i class="ti ti-trash"></i>
        </a>

        {% if not l.leave.superadmin_cancelled and not l.leave.admin_cancelled %}
            {% if request.user.is_superuser %}
                {% if not l.leave.superadmin_approval %}
                    <!-- Superadmin can still approve/decline -->
                    <a href="javascript:void(0);" class="ms-2 update-leave-status"
                       data-leave-id="{{ l.leave.id }}" data-action="approve">
                        <i class="ti ti-check text-success" title="Approve"></i>
                    </a>
                    <a href="javascript:void(0);" class="ms-2 update-leave-status"
                       data-leave-id="{{ l.leave.id }}" data-action="decline">
                        <i class="ti ti-x text-danger" title="Decline"></i>
                    </a>
                {% endif %}
            {% elif l.leave.employee.under == request.user %}
                {% if not l.leave.admin_approval %}
                    <!-- Admin (manager) can approve/decline -->
                    <a href="javascript:void(0);" class="ms-2 update-leave-status"
                       data-leave-id="{{ l.leave.id }}" data-action="approve">
                        <i class="ti ti-check text-success" title="Approve"></i>
                    </a>
                    <a href="javascript:void(0);" class="ms-2 update-leave-status"
                       data-leave-id="{{ l.leave.id }}" data-action="decline">
                        <i class="ti ti-x text-danger" title="Decline"></i>
                    </a>
                {% endif %}
            {% endif %}
        {% endif %}
    </div>
</td>

        </tr>
        {% empty %}
        <tr>
            <td colspan="7" class="text-center">No leave records found.</td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% endif %}



									</div>
								</div>

							</div>
						</div>
					</div>
				</div>
				<!-- /Leaves list -->


			</div>



			<div class="footer d-sm-flex align-items-center justify-content-between border-top bg-white p-3">
				<p class="mb-0">2025 © Webx Hubs.</p>
				<p>Designed &amp; Developed By <a href="javascript:void(0);" class="text-primary">Webx Hubs</a></p>
			</div>
		</div>

		<script>
$(document).on('click', '.update-leave-status', function () {
    const leaveId = $(this).data('leave-id');
    
    $.ajax({
        url: '{% url "update_leave_status" %}',  // You'll define this view below
        method: 'POST',
        data: {
            'leave_id': leaveId,
            'csrfmiddlewaretoken': '{{ csrf_token }}'
        },
        success: function (response) {
            if (response.success) {
                location.reload(); // Refresh to show updated status
            } else {
                alert(response.message || "Error updating status.");
            }
        }
    });
});
</script>


		<div class="modal fade" id="add_leaves">
			<div class="modal-dialog modal-dialog-centered modal-lg">
				<div class="modal-content">
					<div class="modal-header">
						<h4 class="modal-title">Add Leave</h4>
						<button type="button" class="btn-close custom-btn-close" data-bs-dismiss="modal"
							aria-label="Close">
							<i class="ti ti-x"></i>
						</button>
					</div>
					<form id="leave-form" method="POST" enctype="multipart/form-data">
						{% csrf_token %}
						<div class="modal-body pb-0">
							<div class="row">

								<!-- Leave Type -->
								<div class="col-md-6">
									<div class="mb-3">
										<label class="form-label">Leave Type</label>
										<select class="form-select" name="leave_type" required>
											<option value="">Select</option>
											{% for i in alla %}
											<option value="{{ i.name }}">{{ i.name }}</option>
											{% endfor %}
										</select>
									</div>
								</div>

								<!-- Duration Type -->
								<div class="col-md-6">
									<div class="mb-3">
										<label class="form-label">Duration Type</label>
										<select class="form-select" name="duration_type" id="duration_type" required>
											<option value="">Select</option>
											<option value="full">Full Day</option>
											<option value="half">Half Day</option>
										</select>
									</div>
								</div>

								<!-- From Date -->
								<div class="col-md-6 full-day-field">
									<div class="mb-3">
										<label class="form-label">From Date</label>
										<div class="input-icon-end position-relative">
											<input type="text" class="form-control datetimepicker" name="from_date"
												placeholder="dd/mm/yyyy">
											<span class="input-icon-addon">
												<i class="ti ti-calendar text-gray-7"></i>
											</span>
										</div>
									</div>
								</div>

								<!-- To Date -->
								<div class="col-md-6 full-day-field">
									<div class="mb-3">
										<label class="form-label">To Date</label>
										<div class="input-icon-end position-relative">
											<input type="text" class="form-control datetimepicker" name="to_date"
												placeholder="dd/mm/yyyy">
											<span class="input-icon-addon">
												<i class="ti ti-calendar text-gray-7"></i>
											</span>
										</div>
									</div>
								</div>

								<!-- Half Day Date -->
								<div class="col-md-6 half-day-field d-none">
									<div class="mb-3">
										<label class="form-label">Date</label>
										<div class="input-icon-end position-relative">
											<input type="text" class="form-control datetimepicker" name="half_day_date"
												placeholder="dd/mm/yyyy">
											<span class="input-icon-addon">
												<i class="ti ti-calendar text-gray-7"></i>
											</span>
										</div>
									</div>
								</div>

								<!-- First Half / Second Half -->
								<div class="col-md-6 half-day-field d-none">
									<div class="mb-3">
										<label class="form-label">Half Type</label>
										<select class="form-select" name="half_type">
											<option value="">Select</option>
											<option value="first">First Half</option>
											<option value="second">Second Half</option>
										</select>
									</div>
								</div>

								<!-- Attachment -->
								<div class="col-md-6 full-day-field">
									<div class="mb-3">
										<label class="form-label">Attachment (optional)</label>
										<input type="file" class="form-control" name="attachment">
									</div>
								</div>

								<!-- Reason -->
								<div class="col-md-12">
									<div class="mb-3">
										<label class="form-label">Reason</label>
										<textarea class="form-control" name="reason" rows="3" required></textarea>
									</div>
								</div>

							</div>
						</div>

						<div class="modal-footer">
							<button type="button" class="btn btn-light me-2" data-bs-dismiss="modal">Cancel</button>
							<button type="submit" class="btn btn-primary">Add Leave</button>
						</div>
					</form>

				</div>
			</div>
		</div>


		<div class="modal fade" id="edit_leaves">
			<div class="modal-dialog modal-dialog-centered modal-lg">
				<div class="modal-content">
					<div class="modal-header">
						<h4 class="modal-title">Edit Leave</h4>
						<button type="button" class="btn-close custom-btn-close" data-bs-dismiss="modal"
							aria-label="Close">
							<i class="ti ti-x"></i>
						</button>
					</div>
					<form action="leaves.html">
						<div class="modal-body pb-0">
							<div class="row">
								<div class="col-md-12">
									<div class="mb-3">
										<label class="form-label">Leave Type</label>
										<select class="select select2-hidden-accessible"
											data-select2-id="select2-data-7-r57e" tabindex="-1" aria-hidden="true">
											<option selected="" data-select2-id="select2-data-9-9uyz">Medical Leave
											</option>
											<option>Casual Leave</option>
											<option>Annual Leave</option>
										</select><span class="select2 select2-container select2-container--default"
											dir="ltr" data-select2-id="select2-data-8-4lbf" style="width: 100%;"><span
												class="selection"><span
													class="select2-selection select2-selection--single" role="combobox"
													aria-haspopup="true" aria-expanded="false" tabindex="0"
													aria-disabled="false" aria-labelledby="select2-6gdp-container"
													aria-controls="select2-6gdp-container"><span
														class="select2-selection__rendered" id="select2-6gdp-container"
														role="textbox" aria-readonly="true"
														title="Medical Leave">Medical Leave</span><span
														class="select2-selection__arrow" role="presentation"><b
															role="presentation"></b></span></span></span><span
												class="dropdown-wrapper" aria-hidden="true"></span></span>
									</div>
								</div>
								<div class="col-md-6">
									<div class="mb-3">
										<label class="form-label">From </label>
										<div class="input-icon-end position-relative">
											<input type="text" class="form-control datetimepicker" value="14 Jan 24"
												placeholder="dd/mm/yyyy">
											<span class="input-icon-addon">
												<i class="ti ti-calendar text-gray-7"></i>
											</span>
										</div>
									</div>
								</div>
								<div class="col-md-6">
									<div class="mb-3">
										<label class="form-label">To </label>
										<div class="input-icon-end position-relative">
											<input type="text" class="form-control datetimepicker" value="15/01/24"
												placeholder="dd/mm/yyyy">
											<span class="input-icon-addon">
												<i class="ti ti-calendar text-gray-7"></i>
											</span>
										</div>
									</div>
								</div>
								<div class="col-md-6">
									<div class="mb-3">
										<div class="input-icon-end position-relative">
											<input type="text" class="form-control datetimepicker" value="15/01/24"
												disabled="">
											<span class="input-icon-addon">
												<i class="ti ti-calendar text-gray-7"></i>
											</span>
										</div>
									</div>
								</div>
								<div class="col-md-6">
									<div class="mb-3">
										<select class="select select2-hidden-accessible"
											data-select2-id="select2-data-10-eaav" tabindex="-1" aria-hidden="true">
											<option>Select</option>
											<option>Full DAy</option>
											<option selected="" data-select2-id="select2-data-12-9av8">First Half
											</option>
											<option>Second Half</option>
										</select><span class="select2 select2-container select2-container--default"
											dir="ltr" data-select2-id="select2-data-11-8tiw" style="width: 100%;"><span
												class="selection"><span
													class="select2-selection select2-selection--single" role="combobox"
													aria-haspopup="true" aria-expanded="false" tabindex="0"
													aria-disabled="false" aria-labelledby="select2-c9cf-container"
													aria-controls="select2-c9cf-container"><span
														class="select2-selection__rendered" id="select2-c9cf-container"
														role="textbox" aria-readonly="true" title="First Half">First
														Half</span><span class="select2-selection__arrow"
														role="presentation"><b
															role="presentation"></b></span></span></span><span
												class="dropdown-wrapper" aria-hidden="true"></span></span>
									</div>
								</div>


								<div class="col-md-12">
									<div class="d-flex align-items-center mb-3">
										<div class="form-check me-2">
											<input class="form-check-input" type="radio" name="leave1" value="option4"
												id="leave6">
											<label class="form-check-label" for="leave6">
												Full Day
											</label>
										</div>
										<div class="form-check me-2">
											<input class="form-check-input" type="radio" name="leave1" value="option5"
												id="leave5">
											<label class="form-check-label" for="leave5">
												First Half
											</label>
										</div>
										<div class="form-check me-2">
											<input class="form-check-input" type="radio" name="leave1" value="option6"
												id="leave4">
											<label class="form-check-label" for="leave4">
												Second Half
											</label>
										</div>
									</div>
								</div>
								<div class="col-md-12">
									<div class="mb-3">
										<label class="form-label">Reason</label>
										<textarea class="form-control" rows="3"> Going to Hospital </textarea>
									</div>
								</div>
							</div>
						</div>
						<div class="modal-footer">
							<button type="button" class="btn btn-light me-2" data-bs-dismiss="modal">Cancel</button>
							<button type="submit" class="btn btn-primary">Save Changes</button>
						</div>
					</form>
				</div>
			</div>
		</div>
		<script>
			$(document).ready(function () {
				$('#duration_type').on('change', function () {
					const val = $(this).val();
					if (val === 'full') {
						$('.full-day-field').removeClass('d-none');
						$('.half-day-field').addClass('d-none');
					} else if (val === 'half') {
						$('.half-day-field').removeClass('d-none');
						$('.full-day-field').addClass('d-none');
					} else {
						$('.full-day-field, .half-day-field').addClass('d-none');
					}
				});
			});
		</script>


		<div class="modal fade" id="delete_modal">
			<div class="modal-dialog modal-dialog-centered">
				<div class="modal-content">
					<div class="modal-body text-center">
						<span class="avatar avatar-xl bg-transparent-danger text-danger mb-3">
							<i class="ti ti-trash-x fs-36"></i>
						</span>
						<h4 class="mb-1">Confirm Delete</h4>
						<p class="mb-3">You want to delete all the marked items, this cant be undone once you delete.
						</p>
						<div class="d-flex justify-content-center">
							<a href="javascript:void(0);" class="btn btn-light me-3" data-bs-dismiss="modal">Cancel</a>
							<a href="leaves-employee.html" class="btn btn-danger">Yes, Delete</a>
						</div>
					</div>
				</div>
			</div>
		</div>

		<!-- /Page Wrapper -->

	</div>
	<!-- /Main Wrapper -->
	 <script>
    // Toggle full/half-day fields
    $('#duration_type').on('change', function() {
        if ($(this).val() === 'half') {
            $('#full-day-fields').hide();
            $('#half-day-fields').show();
        } else {
            $('#full-day-fields').show();
            $('#half-day-fields').hide();
        }
    });

    // Submit form via AJAX
    $('#leave-form').on('submit', function(e) {
        e.preventDefault();

        var formData = new FormData(this);

        $.ajax({
            type: 'POST',
            url: "{% url 'submit_leave' %}",  // You must define this URL in urls.py
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                alert(response.message || "Leave submitted successfully.");
                location.reload();
            },
            error: function(xhr) {
                alert("Error occurred: " + xhr.responseText);
            }
        });
    });
</script>

<script>
   $(document).on("click", ".update-leave-status", function () {
    const leaveId = $(this).data("leave-id");
    const action = $(this).data("action");

    $.ajax({
        url: "/leave/update-status/",
        type: "POST",
        data: {
            leave_id: leaveId,
            action: action,
            csrfmiddlewaretoken: $("input[name='csrfmiddlewaretoken']").val()
        },
        success: function (response) {
            if (response.success) {
                location.reload(); // Reload to reflect changes
            } else {
                alert(response.message || "Something went wrong.");
            }
        },
        error: function () {
            alert("Request failed.");
        }
    });
});

</script>

	{% include 'js.html' %}
</body>


</html>